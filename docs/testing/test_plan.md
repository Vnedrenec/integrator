# План тестирования и тестовые сценарии

В этом документе описывается план тестирования MVP платформы "BPM Centr" и представлены детальные тестовые сценарии для проверки функциональности системы.

## Цели тестирования

Основные цели тестирования MVP платформы BPM Centr описаны в [общем обзоре стратегии тестирования](overview.md).

Дополнительные цели для MVP:

1. Проверить удобство использования интерфейса
2. Валидировать бизнес-процессы и пользовательские сценарии

## Типы тестирования

Основные типы тестирования описаны в [общем обзоре стратегии тестирования](overview.md).

## Окружения тестирования

### Тестовое окружение

- **Назначение**: Тестирование новых функций и исправлений
- **Доступ**: Только для команды разработки
- **Данные**: Тестовые данные, не содержащие реальной информации
- **Интеграции**: Тестовые аккаунты внешних сервисов (Stripe Sandbox, Make Developer)

### Staging окружение

- **Назначение**: Финальное тестирование перед релизом
- **Доступ**: Команда разработки и ключевые стейкхолдеры
- **Данные**: Копия продакшн-данных с обезличиванием
- **Интеграции**: Тестовые аккаунты внешних сервисов (Stripe Sandbox, Make Developer)

### Продакшн окружение

- **Назначение**: Рабочая версия системы
- **Доступ**: Все пользователи
- **Данные**: Реальные данные
- **Интеграции**: Рабочие аккаунты внешних сервисов (Stripe, Make)

## Тестовые сценарии и тест-кейсы

Ниже представлены детальные тестовые сценарии для проверки функциональности системы.

### Регистрация и аутентификация

#### TC-1: Регистрация нового пользователя

**Описание**: Проверка процесса регистрации нового пользователя в системе.

**Предусловия**: Пользователь не зарегистрирован в системе.

**Шаги**:
1. Открыть страницу регистрации
2. Заполнить форму регистрации:
   - Email: new_user@example.com
   - Пароль: password123
   - Имя: John
   - Фамилия: Doe
3. Нажать кнопку "Зарегистрироваться"

**Ожидаемый результат**:
- Пользователь создан в базе данных со статусом "unverified"
- На указанный email отправлено письмо с ссылкой для подтверждения
- Пользователь перенаправлен на страницу с сообщением о необходимости подтверждения email

**Тестовые данные**:
```json
{
  "email": "new_user@example.com",
  "password": "password123",
  "firstName": "John",
  "lastName": "Doe"
}
```

#### TC-2: Подтверждение email

**Описание**: Проверка процесса подтверждения email после регистрации.

**Предусловия**: Пользователь зарегистрирован, но не подтвердил email.

**Шаги**:
1. Открыть ссылку из письма для подтверждения email
2. Система проверяет токен подтверждения

**Ожидаемый результат**:
- Статус пользователя изменен на "trial"
- Создана подписка со статусом "trial"
- Пользователь перенаправлен на страницу входа с сообщением об успешном подтверждении

#### TC-3: Вход в систему

**Описание**: Проверка процесса аутентификации пользователя в системе.

**Предусловия**: Пользователь зарегистрирован и подтвердил email.

**Шаги**:
1. Открыть страницу входа
2. Ввести email и пароль:
   - Email: user1@example.com
   - Пароль: password123
3. Нажать кнопку "Войти"

**Ожидаемый результат**:
- Пользователь успешно аутентифицирован
- Пользователь получает токены доступа (access token и refresh token)
- Пользователь перенаправлен на дашборд

**Тестовые данные**:
```json
{
  "email": "user1@example.com",
  "password": "password123"
}
```

#### TC-4: Неудачный вход в систему

**Описание**: Проверка обработки неверных учетных данных при входе в систему.

**Предусловия**: Пользователь зарегистрирован.

**Шаги**:
1. Открыть страницу входа
2. Ввести корректный email и неверный пароль
3. Нажать кнопку "Войти"

**Ожидаемый результат**:
- Отображается сообщение об ошибке
- Пользователь остается на странице входа

#### TC-5: Восстановление пароля

**Описание**: Проверка процесса восстановления пароля пользователя.

**Предусловия**: Пользователь зарегистрирован в системе.

**Шаги**:
1. Открыть страницу входа
2. Нажать на ссылку "Забыли пароль?"
3. Ввести email: user1@example.com
4. Нажать кнопку "Отправить"
5. Открыть ссылку из письма для сброса пароля
6. Ввести новый пароль: newpassword123
7. Нажать кнопку "Сохранить"

**Ожидаемый результат**:
- На указанный email отправлено письмо с ссылкой для сброса пароля
- Пароль пользователя изменен
- Пользователь перенаправлен на страницу входа с сообщением об успешном сбросе пароля

**Тестовые данные**:
```json
{
  "email": "user1@example.com",
  "newPassword": "newpassword123"
}
```

#### TC-6: Выход из системы

**Описание**: Проверка процесса выхода пользователя из системы.

**Предусловия**: Пользователь авторизован.

**Шаги**:
1. Нажать на имя пользователя в шапке
2. Выбрать пункт "Выйти"

**Ожидаемый результат**:
- Сессия пользователя завершена
- Пользователь перенаправлен на главную страницу
- В шапке отображаются кнопки "Войти" и "Регистрация"

### Управление профилем

#### TC-7: Просмотр профиля

**Предусловия**: Пользователь авторизован

**Шаги**:
1. Нажать на имя пользователя в шапке
2. Выбрать пункт "Профиль"

**Ожидаемый результат**:
1. Отображается страница профиля
2. На странице отображаются данные пользователя: имя, фамилия, email, компания

#### TC-8: Редактирование профиля

**Предусловия**: Пользователь авторизован и находится на странице профиля

**Шаги**:
1. Изменить значения в полях "Имя", "Фамилия", "Компания"
2. Нажать кнопку "Сохранить изменения"

**Ожидаемый результат**:
1. Данные пользователя обновлены в системе
2. Отображается сообщение об успешном обновлении
3. В шапке отображается обновленное имя пользователя

#### TC-9: Изменение пароля

**Предусловия**: Пользователь авторизован и находится на странице профиля

**Шаги**:
1. Ввести текущий пароль
2. Ввести новый пароль и подтверждение
3. Нажать кнопку "Изменить пароль"

**Ожидаемый результат**:
1. Пароль пользователя изменен
2. Отображается сообщение об успешном изменении пароля
3. На email отправляется уведомление об изменении пароля

### Управление подписками

#### TC-10: Просмотр доступных коннекторов

**Предусловия**: Пользователь авторизован

**Шаги**:
1. Перейти на страницу "Коннекторы"

**Ожидаемый результат**:
1. Отображается список доступных коннекторов
2. Для каждого коннектора отображается: название, категория, стоимость, период, функции
3. Коннекторы, на которые у пользователя есть активные подписки, выделены

#### TC-11: Активация пробного периода

**Предусловия**: Пользователь зарегистрирован, подтвердил email и не имеет активной подписки

**Шаги**:
1. Войти в систему
2. Нажать кнопку "Активировать пробный период" в личном кабинете

**Ожидаемый результат**:
1. Пробный период активирован
2. Статус подписки установлен как "trial"
3. Дата окончания пробного периода установлена на 14 дней вперед
4. Пользователь перенаправлен в личный кабинет
5. Отображается информация о пробном периоде

#### TC-12: Оформление подписки

**Предусловия**: Пользователь авторизован и не имеет активной подписки (или имеет пробную)

**Шаги**:
1. Перейти на страницу "Коннекторы"
2. Выбрать коннектор
3. Нажать кнопку "Выбрать"
4. Выбрать период оплаты (месяц, год)
5. Ввести платежные данные
6. Нажать кнопку "Оплатить"

**Ожидаемый результат**:
1. Платеж успешно обработан через Stripe
2. Подписка активирована
3. Статус подписки установлен как "active"
4. Дата окончания подписки установлена в соответствии с выбранным периодом
5. Пользователь перенаправлен в личный кабинет
6. На email отправляется подтверждение подписки

#### TC-13: Просмотр текущей подписки

**Предусловия**: Пользователь авторизован и имеет активную подписку

**Шаги**:
1. Перейти в раздел "Подписка" в личном кабинете

**Ожидаемый результат**:
1. Отображается информация о текущих подписках: коннектор, аккаунт Make, статус, дата начала, дата окончания
2. Отображается информация об использовании API-ключей
3. Отображается статус автоматического продления
4. Отображается история платежей

#### TC-14: Отмена подписки

**Предусловия**: Пользователь авторизован и имеет активную подписку с включенным автопродлением

**Шаги**:
1. Перейти в раздел "Подписка" в личном кабинете
2. Нажать кнопку "Отменить подписку"
3. Подтвердить отмену

**Ожидаемый результат**:
1. Автоматическое продление отключено
2. Статус подписки изменен на "canceled"
3. Подписка остается активной до конца оплаченного периода
4. Отображается сообщение об успешной отмене
5. На email отправляется подтверждение отмены

#### TC-15: Возобновление подписки

**Предусловия**: Пользователь авторизован и имеет отмененную подписку, которая еще активна

**Шаги**:
1. Перейти в раздел "Подписка" в личном кабинете
2. Нажать кнопку "Возобновить подписку"
3. Подтвердить возобновление

**Ожидаемый результат**:
1. Автоматическое продление включено
2. Статус подписки изменен на "active"
3. Отображается сообщение об успешном возобновлении
4. На email отправляется подтверждение возобновления

### Управление API-ключами

#### TC-16: Создание API-ключа

**Предусловия**: Пользователь авторизован и имеет активную подписку

**Шаги**:
1. Перейти в раздел "API-ключи" в личном кабинете
2. Нажать кнопку "Создать API-ключ"
3. Ввести название ключа
4. Нажать кнопку "Создать"

**Ожидаемый результат**:
1. API-ключ создан
2. Отображается модальное окно с API-ключом
3. Пользователь может скопировать API-ключ
4. После закрытия модального окна ключ отображается в списке с префиксом

#### TC-17: Просмотр списка API-ключей

**Предусловия**: Пользователь авторизован и имеет активную подписку с созданными API-ключами

**Шаги**:
1. Перейти в раздел "API-ключи" в личном кабинете

**Ожидаемый результат**:
1. Отображается список API-ключей пользователя
2. Для каждого ключа отображается: название, префикс, дата создания, последнее использование
3. Отображается количество использованных и доступных API-ключей

#### TC-18: Удаление API-ключа

**Предусловия**: Пользователь авторизован и имеет активную подписку с созданными API-ключами

**Шаги**:
1. Перейти в раздел "API-ключи" в личном кабинете
2. Нажать кнопку "Удалить" для выбранного ключа
3. Подтвердить удаление

**Ожидаемый результат**:
1. API-ключ удален
2. Ключ больше не отображается в списке
3. Отображается сообщение об успешном удалении
4. Количество использованных API-ключей уменьшается на 1

### API для коннекторов

#### TC-19: Проверка статуса подписки с валидным API-ключом

**Предусловия**: Пользователь имеет активную подписку и созданный API-ключ

**Шаги**:
1. Отправить GET-запрос к `/subscription/check` с заголовком `Authorization: Bearer {api_key}` и параметром `connector=test-connector`

**Ожидаемый результат**:
1. Возвращается статус 200 OK
2. В ответе содержится информация о подписке: `{"active": true, "connector": "test-connector", "makeAccountId": "make_account_1", "expiresAt": "2023-05-22T12:00:00Z"}`

#### TC-20: Проверка статуса подписки с невалидным API-ключом

**Предусловия**: API-ключ не существует или не активен

**Шаги**:
1. Отправить GET-запрос к `/subscription/check` с заголовком `Authorization: Bearer invalid_key` и параметром `connector=test-connector`

**Ожидаемый результат**:
1. Возвращается статус 401 Unauthorized
2. В ответе содержится сообщение об ошибке: `{"statusCode": 401, "message": "Invalid API key", "error": "Unauthorized"}`

#### TC-21: Проверка статуса подписки с истекшей подпиской

**Предусловия**: Пользователь имеет истекшую подписку и созданный API-ключ

**Шаги**:
1. Отправить GET-запрос к `/subscription/check` с заголовком `Authorization: Bearer {api_key}` и параметром `connector=test-connector`

**Ожидаемый результат**:
1. Возвращается статус 403 Forbidden
2. В ответе содержится сообщение об ошибке: `{"statusCode": 403, "message": "Subscription inactive or expired", "error": "Forbidden"}`

#### TC-22: Регистрация использования коннектора

**Предусловия**: Пользователь имеет активную подписку и созданный API-ключ

**Шаги**:
1. Отправить POST-запрос к `/connector/usage` с заголовком `Authorization: Bearer {api_key}` и телом `{"connector": "test-connector", "operation": "testOperation", "make_account_id": "make_account_1", "timestamp": "2023-04-23T12:00:00Z"}`

**Ожидаемый результат**:
1. Возвращается статус 201 Created
2. В ответе содержится информация о зарегистрированной операции
3. Операция успешно зарегистрирована в системе

#### TC-23: Проверка с несоответствующим аккаунтом Make

**Предусловия**: Пользователь имеет активную подписку, созданный API-ключ и использовал все доступные операции

**Шаги**:
1. Отправить POST-запрос к `/connector/usage` с заголовком `Authorization: Bearer {api_key}` и телом `{"connector": "test-connector", "operation": "testOperation", "make_account_id": "make_account_1", "timestamp": "2023-04-23T12:00:00Z"}`

**Ожидаемый результат**:
1. Возвращается статус 403 Forbidden
2. В ответе содержится сообщение об ошибке: `{"statusCode": 403, "message": "Subscription inactive or Make account mismatch", "error": "Forbidden"}`

### Панель администратора

#### TC-24: Просмотр списка пользователей

**Предусловия**: Администратор авторизован

**Шаги**:
1. Перейти в раздел "Пользователи" в панели администратора

**Ожидаемый результат**:
1. Отображается список всех пользователей
2. Для каждого пользователя отображается: email, имя, фамилия, компания, статус, дата регистрации
3. Доступны фильтры по статусу и дате регистрации
4. Доступен поиск по email, имени, фамилии, компании

#### TC-25: Просмотр деталей пользователя

**Предусловия**: Администратор авторизован

**Шаги**:
1. Перейти в раздел "Пользователи" в панели администратора
2. Нажать на email пользователя

**Ожидаемый результат**:
1. Отображается страница с детальной информацией о пользователе
2. На странице отображаются: email, имя, фамилия, компания, статус, дата регистрации
3. Отображается информация о подписке пользователя
4. Доступны действия: изменение статуса, сброс пароля

#### TC-26: Изменение статуса пользователя

**Предусловия**: Администратор авторизован и находится на странице деталей пользователя

**Шаги**:
1. Нажать кнопку "Изменить статус"
2. Выбрать новый статус (например, "suspended")
3. Подтвердить изменение

**Ожидаемый результат**:
1. Статус пользователя изменен
2. Отображается сообщение об успешном изменении
3. На странице отображается новый статус

#### TC-27: Просмотр подписок

**Предусловия**: Администратор авторизован

**Шаги**:
1. Перейти в раздел "Подписки" в панели администратора

**Ожидаемый результат**:
1. Отображается список всех подписок
2. Для каждой подписки отображается: пользователь, коннектор, аккаунт Make, статус, даты начала и окончания
3. Доступны фильтры по статусу, коннектору, датам
4. Доступен поиск по email пользователя

## Тестирование интеграций

Ниже представлены сценарии тестирования интеграций с внешними сервисами.

### Интеграция со Stripe

#### TC-28: Создание клиента в Stripe

**Описание**: Проверка процесса создания клиента в Stripe при регистрации пользователя.

**Предусловия**: Пользователь зарегистрирован и подтвердил email.

**Шаги**:
1. Зарегистрировать нового пользователя
2. Подтвердить email

**Ожидаемый результат**:
1. В Stripe создан новый клиент
2. ID клиента сохранен в базе данных

#### TC-29: Создание подписки в Stripe

**Описание**: Проверка процесса создания подписки в Stripe.

**Предусловия**: Пользователь авторизован, имеет stripeCustomerId и не имеет активной подписки.

**Шаги**:
1. Перейти на страницу выбора коннектора
2. Выбрать коннектор для покупки
3. Выбрать план подписки (месячный или годовой)
4. Ввести платежные данные
5. Подтвердить покупку

**Ожидаемый результат**:
1. В Stripe создана подписка
2. В БД сохранена запись о подписке со статусом "active"
3. Пользователь получает доступ к коннектору

**Тестовые данные**:
```json
{
  "connectorId": "connector123",
  "planType": "monthly",
  "paymentMethod": "card",
  "cardNumber": "4242424242424242",
  "expMonth": 12,
  "expYear": 2025,
  "cvc": "123"
}
```

#### TC-30: Отмена подписки в Stripe

**Описание**: Проверка процесса отмены подписки в Stripe.

**Предусловия**: Пользователь авторизован и имеет активную подписку.

**Шаги**:
1. Перейти на страницу управления подписками
2. Выбрать активную подписку
3. Нажать кнопку "Отменить подписку"
4. Подтвердить отмену

**Ожидаемый результат**:
1. В Stripe подписка отменена (автопродление отключено)
2. Статус подписки в системе изменен на "canceled"
3. Пользователь сохраняет доступ к коннектору до конца оплаченного периода

#### TC-31: Обработка webhook от Stripe

**Описание**: Проверка процесса обработки webhook от Stripe.

**Предусловия**: Пользователь имеет активную подписку.

**Шаги**:
1. Создать мок вебхука `invoice.payment_succeeded`
2. Отправить вебхук на эндпоинт `/api/v1/webhooks/stripe`

**Ожидаемый результат**:
1. Система возвращает статус 200
2. В БД создана запись о платеже
3. Статус подписки обновлен

**Тестовые данные**:
```json
{
  "id": "evt_1234567890",
  "object": "event",
  "type": "invoice.payment_succeeded",
  "data": {
    "object": {
      "id": "in_1234567890",
      "customer": "cus_1234567890",
      "subscription": "sub_1234567890",
      "status": "paid",
      "amount_paid": 1999
    }
  }
}
```

### Интеграция с Make

#### TC-32: Проверка подписки из коннектора Make

**Описание**: Проверка процесса валидации API-ключа и подписки из коннектора Make.

**Предусловия**: Пользователь имеет активную подписку и API-ключ.

**Шаги**:
1. Создать запрос к API с валидным API-ключом
2. Отправить запрос на эндпоинт `/api/v1/subscriptions/validate`

**Ожидаемый результат**:
1. Система возвращает статус 200
2. В ответе содержится информация о подписке и ее статусе
3. В логах системы фиксируется запрос к API

**Тестовые данные**:
```json
{
  "apiKey": "valid-api-key-123",
  "makeAccountId": "account123"
}
```

#### TC-33: Проверка недействительного API-ключа

**Описание**: Проверка обработки запроса с недействительным API-ключом.

**Предусловия**: Система настроена для приема API-запросов.

**Шаги**:
1. Создать запрос к API с недействительным API-ключом
2. Отправить запрос на эндпоинт `/api/v1/subscriptions/validate`

**Ожидаемый результат**:
1. Система возвращает статус 401 Unauthorized
2. В ответе содержится сообщение об ошибке
3. В логах системы фиксируется попытка несанкционированного доступа

**Тестовые данные**:
```json
{
  "apiKey": "invalid-api-key-123",
  "makeAccountId": "account123"
}
```

## Тестирование производительности

Детальные сценарии тестирования производительности представлены в файле [Тестирование нагрузки](load_testing.md).

### TC-33: Время отклика API

**Описание**: Проверка времени отклика API при последовательных запросах.

**Подробный сценарий**: [Сценарий в файле Тестирование нагрузки](load_testing.md#процесс-тестирования-нагрузки)

### TC-34: Нагрузочное тестирование API

**Описание**: Проверка работы API при высокой параллельной нагрузке.

**Подробный сценарий**: [Сценарий в файле Тестирование нагрузки](load_testing.md#стресс-тестирование)

## Тестирование безопасности

Детальные сценарии тестирования безопасности представлены в файле [Обеспечение качества](quality_assurance.md#критерии-безопасности).

### TC-35: Защита от SQL-инъекций

**Описание**: Проверка защиты системы от SQL-инъекций в параметрах запросов.

### TC-36: Защита от XSS-атак

**Описание**: Проверка защиты системы от межсайтового скриптинга (XSS).

### TC-37: Защита от CSRF-атак

**Описание**: Проверка защиты системы от подделки межсайтовых запросов (CSRF).

### TC-38: Проверка JWT-токенов

**Описание**: Проверка защиты системы от манипуляций с JWT-токенами.

## Критерии приемки MVP

Критерии приемки MVP определяют минимальные требования, которые должны быть выполнены для успешного запуска продукта.

### Функциональные критерии

1. Все критические (P0) User Stories реализованы и протестированы
2. Все тест-кейсы для критических функций выполнены успешно
3. Интеграции со Stripe и Make работают корректно
4. API для коннекторов работает в соответствии с спецификацией

### Нефункциональные критерии

1. Время отклика API не превышает 500 мс (95-й процентиль)
2. Система выдерживает нагрузку в 1000 параллельных запросов
3. Все проверки безопасности пройдены успешно
4. Пользовательский интерфейс корректно отображается в основных браузерах (Chrome, Firefox, Safari, Edge)
5. Пользовательский интерфейс адаптирован для мобильных устройств

## Инструменты тестирования

### Автоматизированное тестирование

1. **Jest** - для модульного тестирования
2. **Supertest** - для тестирования API
3. **Cypress** - для end-to-end тестирования
4. **React Testing Library** - для тестирования React-компонентов

### Ручное тестирование

1. **Postman** - для тестирования API
2. **Chrome DevTools** - для отладки и тестирования UI
3. **BrowserStack** - для тестирования в различных браузерах и устройствах

### Нагрузочное тестирование

1. **Apache JMeter** - для нагрузочного тестирования API
2. **k6** - для тестирования производительности

### Тестирование безопасности

1. **OWASP ZAP** - для сканирования уязвимостей
2. **SonarQube** - для статического анализа кода

## Процесс тестирования

1. **Разработка тест-кейсов** - на основе User Stories и требований
2. **Модульное тестирование** - разработчиками в процессе разработки
3. **Интеграционное тестирование** - после интеграции компонентов
4. **Функциональное тестирование** - после завершения разработки функциональности
5. **Регрессионное тестирование** - при внесении изменений в существующую функциональность
6. **Приемочное тестирование** - перед релизом MVP

## Отчетность о тестировании

1. **Отчеты о выполнении тест-кейсов** - статус выполнения каждого тест-кейса
2. **Отчеты о дефектах** - описание найденных дефектов, их приоритет и статус
3. **Отчеты о покрытии кода тестами** - процент покрытия кода тестами
4. **Отчеты о производительности** - результаты нагрузочного тестирования
5. **Отчеты о безопасности** - результаты тестирования безопасности
