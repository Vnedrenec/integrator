# Развертывание

## Окружения
- Development - для разработки
- Staging - для тестирования
- Production - для конечных пользователей

## Конфигурация окружений
- Файлы env: `.env.development`, `.env.staging`, `.env.production` (не хранить в репозитории).
- Переменные: `DATABASE_URL`, `REDIS_URL`, `JWT_SECRET`, `STRIPE_API_KEY`, `PAYPAL_SECRET`, `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `KUBE_CONFIG`.
- Хранить секреты в Vault/AWS Secrets Manager (12-factor app).

## CI/CD
- CI (GitHub Actions/GitLab CI):
  - Шаги: lint (ESLint, Prettier), тесты (unit/integration), security scan (Snyk), сборка Docker.
- CD:
  - Staging: автоматический деплой Docker-образа в ECR/GCR и применение Helm-чартов в Kubernetes.
  - Production: ручное подтверждение, canary-deploy, откат одним кликом.
- Бранчинг: trunk-based или gitflow, теги для релизов.

## Контейнеризация
- Multi-stage Dockerfile: builder + runtime (например, `node:18-alpine`).
- Минимальный образ, свежие security-патчи.
- Локальные тесты: `docker-compose up`.

## Оркестрация (Kubernetes)
- Манифесты: Deployment, Service, Ingress (nginxIngressController).
- ConfigMap и Secret для параметров.
- HPA (autoscaling по CPU/памяти), Liveness/Readiness probes.

## Инфраструктура как код (Terraform)
- Модули: network (VPC, subnets), compute (EKS/EC2), database (RDS, Redis).
- Remote backend: S3 + DynamoDB для state и блокировки.
- Команды: `terraform init`, `plan`, `apply`, `destroy`.

## Секреты и управление конфигурацией
- HashiCorp Vault/AWS Secrets Manager: ротация ключей, доступ по ролям.

## CI/CD
- Автоматическое тестирование при каждом коммите
- Автоматическое развертывание в Staging после успешных тестов
- Ручное подтверждение для развертывания в Production
- Возможность быстрого отката в случае проблем

## Анализ рисков и план митигации

### Технические риски
| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Сбои в интеграции со Stripe | Средняя | Высокое | Тщательное тестирование, мониторинг вебхуков, резервный механизм обработки платежей |
| Проблемы с доступностью API | Низкая | Высокое | Горизонтальное масштабирование, балансировка нагрузки, мониторинг и алертинг |
| Утечка данных | Низкая | Критическое | Шифрование данных, регулярный аудит безопасности, ограничение доступа |
| Проблемы с производительностью БД | Средняя | Высокое | Оптимизация запросов, индексирование, мониторинг нагрузки |

### Бизнес-риски
| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Низкая конверсия из trial | Средняя | Высокое | A/B тестирование, улучшение onboarding, email-напоминания |
| Высокий churn rate | Средняя | Высокое | Анализ причин отмены подписок, улучшение продукта, программа лояльности |
| Проблемы с интеграцией Make | Низкая | Критическое | Тесное взаимодействие с командой Make, тщательное тестирование |
| Недостаточный спрос | Средняя | Высокое | Маркетинговые активности, фокус на ценностном предложении |

### План действий при возникновении проблем
1. **Проблемы с платежами**: временное продление доступа пользователям, ручная обработка платежей
2. **Недоступность API**: переключение на резервную инфраструктуру, оповещение пользователей
3. **Проблемы с интеграцией Make**: временное отключение проблемных функций, быстрый выпуск патчей

## Миграция данных

### Стратегия миграции данных

#### Миграции схемы БД
- Использование TypeORM для управления миграциями схемы
- Версионирование миграций с использованием таймстемпов (YYYYMMDDHHMMSS_MigrationName)
- Автоматическая генерация миграций на основе изменений в моделях
- Ручное написание миграций для сложных изменений

#### Процесс миграции
1. **Подготовка**:
   - Создание резервной копии БД перед миграцией
   - Тестирование миграций на тестовой среде
   - Планирование окна обслуживания для миграции

2. **Выполнение**:
   - Включение режима обслуживания для пользователей
   - Запуск миграций с мониторингом прогресса
   - Проверка целостности данных после миграции

3. **Откат в случае проблем**:
   - План отката миграций (rollback)
   - Восстановление из резервной копии при критических ошибках

#### Особые случаи миграций
- **Миграция больших таблиц**:
  - Постепенная миграция по частям (batching)
  - Использование временных таблиц для сложных преобразований

- **Изменение структуры данных**:
  - Последовательные миграции с промежуточными состояниями
  - Дублирование данных в новых структурах до полного перехода

#### Тестирование миграций
- Автоматические тесты для миграций (up/down)
- Проверка производительности миграций на тестовых данных
- Тестирование сценариев отката
