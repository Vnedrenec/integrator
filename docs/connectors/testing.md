# Тестирование коннекторов

В этом документе описываются подходы, методы и инструменты для тестирования коннекторов, разрабатываемых для платформы Make в рамках проекта "BPM Centr".

## Типы тестирования

### Модульное тестирование

Модульное тестирование направлено на проверку отдельных компонентов коннектора в изоляции от других компонентов.

**Что тестируется**:
- Отдельные функции и методы
- Адаптеры для внешнего API
- Утилиты и вспомогательные функции
- Механизм проверки подписки

**Инструменты**:
- Jest
- Mocha + Chai
- Sinon (для моков и стабов)

**Пример модульного теста**:

```javascript
// subscription.test.js
const { checkSubscription } = require('../utils/subscription');
const nock = require('nock');

describe('Subscription Utils', () => {
  describe('checkSubscription', () => {
    it('should return true for active subscription', async () => {
      // Arrange
      const bpmCentrApiKey = 'test-api-key';
      const connectorName = 'test-connector';
      const context = {
        http: {
          get: jest.fn().mockResolvedValue({
            statusCode: 200,
            body: { active: true }
          })
        }
      };
      
      // Act
      const result = await checkSubscription(bpmCentrApiKey, connectorName, context);
      
      // Assert
      expect(result).toBe(true);
      expect(context.http.get).toHaveBeenCalledWith({
        url: 'https://api.bpmcentr.ru/subscription/check',
        headers: {
          'Authorization': `Bearer ${bpmCentrApiKey}`
        },
        params: {
          connector: connectorName
        }
      });
    });
    
    it('should throw error for inactive subscription', async () => {
      // Arrange
      const bpmCentrApiKey = 'test-api-key';
      const connectorName = 'test-connector';
      const context = {
        http: {
          get: jest.fn().mockResolvedValue({
            statusCode: 200,
            body: { active: false }
          })
        }
      };
      
      // Act & Assert
      await expect(checkSubscription(bpmCentrApiKey, connectorName, context))
        .rejects
        .toThrow('Your subscription is inactive or expired. Please renew your subscription at BPM Centr.');
    });
    
    it('should throw error when API returns error', async () => {
      // Arrange
      const bpmCentrApiKey = 'test-api-key';
      const connectorName = 'test-connector';
      const context = {
        http: {
          get: jest.fn().mockRejectedValue(new Error('API error'))
        }
      };
      
      // Act & Assert
      await expect(checkSubscription(bpmCentrApiKey, connectorName, context))
        .rejects
        .toThrow('Subscription check failed: API error');
    });
  });
});
```

### Интеграционное тестирование

Интеграционное тестирование направлено на проверку взаимодействия между различными компонентами коннектора и внешними системами.

**Что тестируется**:
- Взаимодействие с API BPM Centr
- Взаимодействие с внешним API
- Взаимодействие между модулями коннектора
- Преобразование данных между системами

**Инструменты**:
- Jest
- Nock (для мокирования HTTP-запросов)
- Supertest (для тестирования API)

**Пример интеграционного теста**:

```javascript
// contacts-module.test.js
const contactsModule = require('../modules/contacts');
const nock = require('nock');

describe('Contacts Module', () => {
  beforeEach(() => {
    // Мокируем API BPM Centr для проверки подписки
    nock('https://api.bpmcentr.ru')
      .get('/subscription/check')
      .query({ connector: 'my-connector' })
      .reply(200, { active: true });
    
    // Мокируем внешний API
    nock('https://api.example.com')
      .get('/contacts/12345')
      .reply(200, {
        id: '12345',
        name: 'John Doe',
        email: 'john@example.com',
        phone: '+1234567890',
        created_at: '2023-01-15T10:30:00Z'
      });
  });
  
  afterEach(() => {
    nock.cleanAll();
  });
  
  describe('getContact operation', () => {
    it('should retrieve contact by ID', async () => {
      // Arrange
      const params = { contactId: '12345' };
      const context = {
        auth: {
          bpmCentrApiKey: 'test-api-key',
          access_token: 'test-access-token'
        },
        http: {
          get: jest.fn().mockImplementation((options) => {
            if (options.url === 'https://api.bpmcentr.ru/subscription/check') {
              return Promise.resolve({
                statusCode: 200,
                body: { active: true }
              });
            } else if (options.url === 'https://api.example.com/contacts/12345') {
              return Promise.resolve({
                statusCode: 200,
                body: {
                  id: '12345',
                  name: 'John Doe',
                  email: 'john@example.com',
                  phone: '+1234567890',
                  created_at: '2023-01-15T10:30:00Z'
                }
              });
            }
          })
        }
      };
      
      // Act
      const result = await contactsModule.operations.find(op => op.name === 'getContact').execute(params, context);
      
      // Assert
      expect(result).toEqual({
        id: '12345',
        name: 'John Doe',
        email: 'john@example.com',
        phone: '+1234567890',
        createdAt: '2023-01-15T10:30:00Z'
      });
    });
  });
});
```

### Функциональное тестирование

Функциональное тестирование направлено на проверку соответствия коннектора функциональным требованиям и пользовательским сценариям.

**Что тестируется**:
- Полный цикл работы коннектора
- Соответствие требованиям
- Пользовательские сценарии
- Обработка ошибок и исключительных ситуаций

**Инструменты**:
- Postman
- Make API
- Ручное тестирование в интерфейсе Make

**Пример функционального теста**:

```javascript
// Пример тестового сценария в Make
const scenario = {
  name: 'Test Contact Creation',
  modules: [
    {
      type: 'trigger',
      connector: 'core',
      operation: 'httpRequest',
      parameters: {
        url: 'https://webhook.site/your-webhook-id',
        method: 'GET'
      }
    },
    {
      type: 'action',
      connector: 'MyConnector',
      operation: 'createContact',
      parameters: {
        name: 'Test Contact',
        email: 'test@example.com',
        phone: '+1234567890'
      }
    },
    {
      type: 'action',
      connector: 'MyConnector',
      operation: 'getContact',
      parameters: {
        contactId: '{{2.id}}'
      }
    }
  ]
};

// Запуск сценария и проверка результатов
async function testScenario() {
  const result = await makeApi.runScenario(scenario);
  
  // Проверка результатов
  expect(result.modules[1].output.id).toBeDefined();
  expect(result.modules[1].output.name).toBe('Test Contact');
  expect(result.modules[1].output.email).toBe('test@example.com');
  
  expect(result.modules[2].output.id).toBe(result.modules[1].output.id);
  expect(result.modules[2].output.name).toBe('Test Contact');
  expect(result.modules[2].output.email).toBe('test@example.com');
}
```

### Нагрузочное тестирование

Нагрузочное тестирование направлено на проверку производительности коннектора при высокой нагрузке и определение его предельных возможностей.

**Что тестируется**:
- Производительность при высокой нагрузке
- Время отклика
- Использование ресурсов
- Стабильность при длительной работе

**Инструменты**:
- Artillery
- JMeter
- k6

**Пример нагрузочного теста**:

```yaml
# artillery-test.yml
config:
  target: "https://api.bpmcentr.com"
  phases:
    - duration: 60
      arrivalRate: 5
      rampTo: 20
      name: "Warm up"
    - duration: 120
      arrivalRate: 20
      name: "Sustained load"
  defaults:
    headers:
      Authorization: "Bearer {{apiKey}}"
      Content-Type: "application/json"
  variables:
    apiKey: "test-api-key"

scenarios:
  - name: "Get and create contacts"
    flow:
      - get:
          url: "/v1/connectors/my-connector/contacts?limit=10"
          capture:
            - json: "$.items[0].id"
              as: "contactId"
      - get:
          url: "/v1/connectors/my-connector/contacts/{{contactId}}"
      - post:
          url: "/v1/connectors/my-connector/contacts"
          json:
            name: "Test Contact"
            email: "test-{{$randomString(10)}}@example.com"
            phone: "+1234567890"
```

## Методология тестирования

### Подготовка тестовых данных

1. **Создание тестовых аккаунтов**
   - Создайте тестовые аккаунты во внешних сервисах
   - Настройте тестовые данные в этих аккаунтах
   - Обеспечьте изоляцию тестовых данных от продакшн-данных

2. **Подготовка тестовых наборов данных**
   - Создайте наборы данных для различных сценариев тестирования
   - Подготовьте данные для позитивных и негативных тестов
   - Обеспечьте воспроизводимость тестовых данных

3. **Настройка тестового окружения**
   - Настройте тестовое окружение, изолированное от продакшн-окружения
   - Настройте доступы и права для тестирования
   - Подготовьте инструменты для мониторинга и анализа результатов тестирования

### Автоматизация тестирования

1. **Разработка автоматических тестов**
   - Создайте набор автоматических тестов для различных уровней тестирования
   - Обеспечьте покрытие всех критических функций
   - Реализуйте тесты для проверки граничных условий и обработки ошибок

2. **Настройка CI/CD для запуска тестов**
   - Интегрируйте тесты в процесс CI/CD
   - Настройте автоматический запуск тестов при изменении кода
   - Настройте отчеты о результатах тестирования

3. **Мониторинг результатов тестирования**
   - Анализируйте результаты тестирования
   - Отслеживайте тренды и паттерны ошибок
   - Используйте результаты тестирования для улучшения качества кода

### Тестирование в различных окружениях

1. **Тестирование в разработческом окружении**
   - Тестирование во время разработки
   - Быстрая обратная связь для разработчиков
   - Проверка базовой функциональности

2. **Тестирование в тестовом окружении**
   - Полное тестирование перед выпуском
   - Проверка интеграции с другими системами
   - Тестирование производительности и безопасности

3. **Тестирование в продакшн-окружении**
   - Проверка работоспособности в реальных условиях
   - Мониторинг производительности и стабильности
   - Сбор обратной связи от пользователей

## Чек-лист тестирования коннектора

### Базовая функциональность

- [ ] Аутентификация работает корректно
- [ ] Все операции выполняются успешно
- [ ] Все триггеры срабатывают корректно
- [ ] Обработка ошибок работает правильно
- [ ] Проверка подписки работает корректно

### Обработка данных

- [ ] Корректное преобразование данных
- [ ] Правильная обработка специальных символов
- [ ] Корректная работа с большими объемами данных
- [ ] Правильная обработка пустых значений
- [ ] Корректная обработка дат и времени

### Производительность

- [ ] Время отклика в пределах допустимых значений
- [ ] Оптимальное использование ресурсов
- [ ] Корректная работа при высокой нагрузке
- [ ] Эффективное использование кэширования
- [ ] Стабильность при длительной работе

### Безопасность

- [ ] Безопасное хранение учетных данных
- [ ] Защита от инъекций и других атак
- [ ] Соответствие требованиям безопасности
- [ ] Корректная обработка конфиденциальных данных
- [ ] Проверка прав доступа

### Интеграция

- [ ] Корректная интеграция с API BPM Centr
- [ ] Корректная интеграция с внешним API
- [ ] Совместимость с различными версиями API
- [ ] Корректная обработка изменений в API
- [ ] Соответствие документации API

### Пользовательский опыт

- [ ] Понятные и информативные сообщения об ошибках
- [ ] Корректное отображение в интерфейсе Make
- [ ] Удобство использования и настройки
- [ ] Соответствие ожиданиям пользователей
- [ ] Качество документации и примеров

## Инструменты для тестирования

### Инструменты для модульного и интеграционного тестирования

1. **Jest** - фреймворк для тестирования JavaScript/TypeScript
   - Простой и мощный синтаксис
   - Встроенные моки и стабы
   - Поддержка асинхронного кода
   - Генерация отчетов о покрытии

2. **Mocha + Chai** - комбинация фреймворка и библиотеки утверждений
   - Гибкая настройка
   - Поддержка различных стилей утверждений
   - Хорошая интеграция с другими инструментами

3. **Sinon** - библиотека для создания моков, стабов и шпионов
   - Мокирование функций и объектов
   - Отслеживание вызовов функций
   - Имитация поведения внешних зависимостей

4. **Nock** - библиотека для мокирования HTTP-запросов
   - Перехват и мокирование HTTP-запросов
   - Проверка отправленных запросов
   - Имитация различных ответов сервера

### Инструменты для функционального тестирования

1. **Postman** - инструмент для тестирования API
   - Создание и выполнение HTTP-запросов
   - Автоматизация тестирования API
   - Создание коллекций тестов
   - Генерация отчетов

2. **Make API** - API для управления сценариями в Make
   - Создание и запуск сценариев
   - Получение результатов выполнения
   - Автоматизация тестирования в Make

3. **Cypress** - инструмент для end-to-end тестирования
   - Тестирование веб-интерфейсов
   - Запись и воспроизведение действий пользователя
   - Визуальное отображение процесса тестирования

### Инструменты для нагрузочного тестирования

1. **Artillery** - инструмент для нагрузочного тестирования
   - Создание сценариев нагрузки
   - Генерация отчетов о производительности
   - Интеграция с CI/CD

2. **JMeter** - инструмент для нагрузочного тестирования
   - Широкие возможности настройки
   - Поддержка различных протоколов
   - Визуальное представление результатов

3. **k6** - современный инструмент для нагрузочного тестирования
   - JavaScript API
   - Высокая производительность
   - Интеграция с облачными платформами

## Лучшие практики тестирования

### Организация тестов

1. **Структурируйте тесты по уровням**
   - Модульные тесты
   - Интеграционные тесты
   - Функциональные тесты
   - Нагрузочные тесты

2. **Группируйте тесты по функциональности**
   - Тесты аутентификации
   - Тесты операций
   - Тесты триггеров
   - Тесты обработки ошибок

3. **Используйте описательные имена тестов**
   - Указывайте, что тестируется
   - Указывайте ожидаемый результат
   - Используйте понятные и информативные имена

### Написание эффективных тестов

1. **Следуйте принципу AAA (Arrange-Act-Assert)**
   - Arrange: подготовка данных и окружения
   - Act: выполнение тестируемого кода
   - Assert: проверка результатов

2. **Тестируйте граничные условия**
   - Пустые значения
   - Максимальные и минимальные значения
   - Специальные символы и форматы

3. **Изолируйте тесты**
   - Каждый тест должен быть независимым
   - Используйте моки и стабы для изоляции
   - Очищайте состояние между тестами

### Автоматизация и CI/CD

1. **Интегрируйте тесты в CI/CD**
   - Запускайте тесты при каждом коммите
   - Блокируйте слияние при неуспешных тестах
   - Генерируйте отчеты о покрытии

2. **Оптимизируйте время выполнения тестов**
   - Запускайте тесты параллельно
   - Используйте кэширование
   - Приоритизируйте критические тесты

3. **Мониторьте качество тестов**
   - Отслеживайте покрытие кода
   - Анализируйте стабильность тестов
   - Улучшайте тесты на основе обратной связи

## Связанные разделы

- [Обзор коннекторов](overview.md)
- [Структура коннекторов](structure.md)
- [Разработка коннекторов](development.md)
- [Примеры коннекторов](examples/)
