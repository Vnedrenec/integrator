# Процессы и бизнес-логика

Этот файл описывает основные процессы и сценарии бизнес-логики проекта "BPM Centr".

## Процесс регистрации и активации пробного периода

1. Пользователь заполняет форму регистрации (email, пароль, имя, фамилия)
2. Система создает учетную запись пользователя со статусом "неподтвержденный"
3. Система отправляет email с ссылкой для подтверждения
4. Пользователь переходит по ссылке и подтверждает email
5. Система активирует учетную запись и создает подписку со статусом "trial"
6. Система генерирует API-ключ для пользователя
7. Пользователь получает доступ к личному кабинету и инструкциям по использованию коннектора

#### Альтернативные ветки и таймауты
- Если пользователь не подтверждает email в течение 24 часов, отправить повторное письмо (максимум 2 попытки через 12 часов).
- Срок действия ссылки истекает через 48 часов.
- При ошибке отправки email (SMTP) логировать событие и повторять отправку 3 раза с экспоненциальным бэкофом (10 с, 30 с, 90 с).

#### State Machine: User
| Состояние       | Событие               | Следующее состояние |
|-----------------|-----------------------|---------------------|
| unverified      | register              | unverified          |
| unverified      | email_verified        | trial               |
| trial           | payment_success       | active              |
| trial           | trial_expired         | expired             |
| active          | cancel                | canceled            |
| active          | payment_failed        | payment_pending     |
| payment_pending | payment_success       | active              |
| payment_pending | payment_failed        | suspended           |

## Процесс управления подписками

#### Активация платной подписки
1. За 2 дня до окончания пробного периода система отправляет уведомление
2. Пользователь вводит платежные данные в личном кабинете
3. Система создает клиента и подписку в Stripe
4. По окончании пробного периода система меняет статус подписки на "active"
5. Stripe автоматически списывает $10 за первый месяц
6. Система обновляет дату окончания подписки

#### Регулярное списание
1. За 3 дня до окончания оплаченного периода система отправляет уведомление
2. Stripe автоматически списывает $10 за следующий период
3. Система обрабатывает вебхук от Stripe о успешном платеже
4. Система обновляет дату окончания подписки
5. Система отправляет уведомление о успешном продлении подписки

#### Отмена подписки
1. Пользователь нажимает кнопку "Отменить подписку" в личном кабинете
2. Система запрашивает подтверждение и причину отмены
3. Система отменяет подписку в Stripe (с сохранением доступа до конца периода)
4. Система меняет статус подписки на "canceled"
5. По окончании оплаченного периода система меняет статус на "expired"
6. Система отзывает доступ к API коннектора

#### Альтернативные сценарии
- Если платеж не проходит (Stripe webhook `invoice.payment_failed`), перевести подписку в `payment_pending` и отправить уведомление:
  - Повторная попытка через 24 часа (максимум 3 попытки).
- Если пользователь не реагирует в течение 3 дней, автоматически отменить подписку.
- При событии `invoice.payment_succeeded` перевести подписку в `active`.

#### State Machine: Subscription
| Состояние        | Событие                      | Следующее состояние    |
|------------------|------------------------------|------------------------|
| trial            | trial_expired                | expired                |
| trial            | payment_success              | active                 |
| active           | cancel                       | canceled               |
| active           | subscription_cancelled       | canceled               |
| payment_pending  | payment_success              | active                 |
| payment_pending  | payment_failed               | canceled               |
| expired          | reactivate                   | active (if payment)    |
| canceled         | reactivate                   | active (if payment)    |

## Процесс интеграции с Make

#### Установка коннектора
1. Пользователь получает API-ключ в личном кабинете
2. Пользователь устанавливает коннектор в своем аккаунте Make
3. При настройке коннектора пользователь вводит API-ключ
4. Коннектор Make отправляет запрос на валидацию ключа
5. Система проверяет валидность ключа и статус подписки
6. Система возвращает результат валидации
7. При успешной валидации пользователь получает доступ к функциям коннектора

#### Использование коннектора
1. При каждом использовании коннектора в Make отправляется запрос к API платформы
2. Система проверяет валидность ключа и статус подписки
3. Система логирует использование API
4. Система возвращает данные или ошибку в зависимости от статуса подписки

#### Webhook Triggers and Retry Logic
- При событии от Make (webhook) система проверяет подпись; если не валидна, возвращает 400, логирует и отменяет обработку.
- При сбое обработки возвращать 5xx (Make повторит webhook через 30 с, до 5 раз).
- После успешной обработки отправлять событие в шину сообщений для асинхронной обработки.

#### State Machine: Connector Usage
| Состояние        | Событие         | Следующее состояние |
|------------------|-----------------|---------------------|
| request_received | valid_key       | processed           |
| request_received | invalid_key     | rejected            |
| processed        | success         | logged              |
| processed        | error           | retry               |
| retry            | retry_success   | processed           |
| retry            | retry_failed    | failed              |

## Матрица ответственности (RACI)

### Описание ролей RACI
- **R (Responsible)** — Исполнитель, ответственный за выполнение задачи
- **A (Accountable)** — Ответственный за результат, принимает решения
- **C (Consulted)** — Консультант, с которым необходимо согласование
- **I (Informed)** — Информируемый, которого необходимо держать в курсе

### Матрица RACI по процессам

| Процесс | Product Manager | Tech Lead | Developer | QA | DevOps | Support |
|----------|----------------|-----------|-----------|----|---------|---------|
| **Разработка функциональных требований** | A/R | C | I | C | I | C |
| **Архитектурные решения** | I | A/R | C | I | C | I |
| **Разработка кода** | I | A | R | C | I | I |
| **Тестирование** | I | A | C | R | I | I |
| **Развертывание** | I | A | C | I | R | I |
| **Интеграция со Stripe** | C | A | R | C | I | I |
| **Интеграция с Make** | C | A | R | C | I | I |
| **Интеграция с SendPulse** | C | A | R | C | I | I |
| **Мониторинг и поддержка** | I | C | I | I | A | R |
| **Управление подписками** | A | I | I | I | I | R |
| **Работа с обращениями пользователей** | C | I | I | I | I | A/R |

### Ответственность по фазам проекта

| Фаза | Product Manager | Tech Lead | Developer | QA | DevOps | Support |
|----------|----------------|-----------|-----------|----|---------|---------|
| **Планирование MVP** | A/R | C | I | C | C | I |
| **Разработка MVP** | A | R | R | C | C | I |
| **Тестирование MVP** | C | A | C | R | I | I |
| **Запуск MVP** | A | C | C | C | R | I |
| **Поддержка после запуска** | C | C | C | I | C | A/R |
| **Расширение функциональности** | A/R | C | I | I | I | C |
