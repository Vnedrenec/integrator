# Мониторинг и аналитика

В этом документе описывается система мониторинга и аналитики платформы "BPM Centr", включая мониторинг использования коннекторов, аналитические инструменты для администраторов и систему оповещений о проблемах и сбоях.

## Система мониторинга использования коннекторов

### Архитектура системы мониторинга

Система мониторинга использования коннекторов построена на основе следующих компонентов:

1. **Сбор данных** - регистрация всех операций коннекторов через API
2. **Хранение данных** - сохранение данных об использовании в базе данных
3. **Обработка данных** - агрегация и анализ данных об использовании
4. **Визуализация данных** - представление данных в виде графиков и отчетов

### Сбор данных об использовании коннекторов

Каждый коннектор при выполнении операции отправляет информацию об использовании в API платформы BPM Centr:

```javascript
async function registerUsage(bpmCentrApiKey, connectorName, operationName, makeAccountId, context) {
  try {
    // Запрос к API BPM Centr для регистрации использования
    const response = await context.http.post({
      url: 'https://api.bpmcentr.ru/v1/connector/usage',
      headers: {
        'Authorization': `Bearer ${bpmCentrApiKey}`,
        'Content-Type': 'application/json'
      },
      body: {
        connector: connectorName,
        operation: operationName,
        make_account_id: makeAccountId,
        timestamp: new Date().toISOString()
      }
    });

    // Проверка результата
    if (response.statusCode !== 201) {
      throw new Error(`Failed to register usage: ${response.body.message || 'Unknown error'}`);
    }

    return true;
  } catch (error) {
    // Логирование ошибки, но не прерывание основной операции
    console.error(`Usage registration failed: ${error.message}`);
    return false;
  }
}
```

### Хранение данных об использовании

Данные об использовании коннекторов хранятся в таблице `connector_usage` в базе данных:

```sql
CREATE TABLE connector_usage (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    api_key_id UUID NOT NULL REFERENCES api_keys(id) ON DELETE CASCADE,
    connector_id VARCHAR(50) NOT NULL REFERENCES connectors(id),
    make_account_id VARCHAR(100) NOT NULL,
    operation VARCHAR(100) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    status VARCHAR(20) NOT NULL,
    error_message TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    CONSTRAINT status_check CHECK (status IN ('success', 'error'))
);

-- Индексы для оптимизации запросов
CREATE INDEX idx_connector_usage_api_key_id ON connector_usage(api_key_id);
CREATE INDEX idx_connector_usage_connector_id ON connector_usage(connector_id);
CREATE INDEX idx_connector_usage_timestamp ON connector_usage(timestamp);
CREATE INDEX idx_connector_usage_status ON connector_usage(status);
```

### Агрегация данных

Для оптимизации запросов и ускорения формирования отчетов система выполняет агрегацию данных об использовании:

1. **Ежечасная агрегация** - агрегация данных по часам для оперативного мониторинга
2. **Ежедневная агрегация** - агрегация данных по дням для ежедневных отчетов
3. **Ежемесячная агрегация** - агрегация данных по месяцам для долгосрочной аналитики

```sql
CREATE TABLE connector_usage_hourly (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    connector_id VARCHAR(50) NOT NULL REFERENCES connectors(id),
    hour TIMESTAMP NOT NULL,
    operation_count INTEGER NOT NULL,
    error_count INTEGER NOT NULL,
    unique_users INTEGER NOT NULL,
    avg_response_time FLOAT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (connector_id, hour)
);

CREATE TABLE connector_usage_daily (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    connector_id VARCHAR(50) NOT NULL REFERENCES connectors(id),
    day DATE NOT NULL,
    operation_count INTEGER NOT NULL,
    error_count INTEGER NOT NULL,
    unique_users INTEGER NOT NULL,
    avg_response_time FLOAT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (connector_id, day)
);

CREATE TABLE connector_usage_monthly (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    connector_id VARCHAR(50) NOT NULL REFERENCES connectors(id),
    month DATE NOT NULL,
    operation_count INTEGER NOT NULL,
    error_count INTEGER NOT NULL,
    unique_users INTEGER NOT NULL,
    avg_response_time FLOAT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT NOW(),
    UNIQUE (connector_id, month)
);
```

### Метрики мониторинга

Система мониторинга отслеживает следующие метрики:

1. **Количество операций** - общее количество выполненных операций
2. **Количество ошибок** - количество операций, завершившихся с ошибкой
3. **Процент ошибок** - отношение количества ошибок к общему количеству операций
4. **Время выполнения** - среднее время выполнения операций
5. **Количество уникальных пользователей** - количество уникальных пользователей, использующих коннектор
6. **Распределение по операциям** - распределение использования по различным операциям коннектора

### Мониторинг в реальном времени

Для мониторинга в реальном времени используются следующие инструменты:

1. **Prometheus** - сбор метрик в реальном времени
2. **Grafana** - визуализация метрик в реальном времени
3. **Alertmanager** - система оповещений о проблемах

#### Prometheus метрики

```
# Количество операций
connector_operations_total{connector="crm-connector", operation="getContact", status="success"} 1234

# Время выполнения операций
connector_operation_duration_seconds{connector="crm-connector", operation="getContact", quantile="0.5"} 0.123
connector_operation_duration_seconds{connector="crm-connector", operation="getContact", quantile="0.9"} 0.456
connector_operation_duration_seconds{connector="crm-connector", operation="getContact", quantile="0.99"} 0.789

# Количество ошибок
connector_errors_total{connector="crm-connector", operation="getContact", error_type="auth_error"} 12
```

#### Grafana дашборды

1. **Общий дашборд** - общая информация о всех коннекторах
2. **Дашборд коннектора** - детальная информация о конкретном коннекторе
3. **Дашборд ошибок** - информация об ошибках и их распределении
4. **Дашборд пользователей** - информация об использовании коннекторов пользователями

## Аналитические инструменты для администраторов

### Панель администратора

Панель администратора предоставляет доступ к аналитическим инструментам для отслеживания использования коннекторов и поведения пользователей:

1. **Общая статистика** - общая информация о платформе
2. **Статистика коннекторов** - информация об использовании коннекторов
3. **Статистика пользователей** - информация о пользователях и их активности
4. **Финансовая статистика** - информация о доходах и платежах
5. **Статистика ошибок** - информация об ошибках и проблемах

### Общая статистика

Общая статистика предоставляет информацию о платформе в целом:

1. **Количество активных пользователей** - количество пользователей, активно использующих платформу
2. **Количество активных подписок** - количество активных подписок на коннекторы
3. **Общее количество операций** - общее количество выполненных операций
4. **Процент ошибок** - общий процент ошибок по всем коннекторам
5. **Доход** - общий доход от подписок

### Статистика коннекторов

Статистика коннекторов предоставляет детальную информацию об использовании каждого коннектора:

1. **Количество активных подписок** - количество активных подписок на коннектор
2. **Количество операций** - количество выполненных операций коннектора
3. **Распределение по операциям** - распределение использования по различным операциям коннектора
4. **Процент ошибок** - процент ошибок по коннектору
5. **Распределение ошибок** - распределение ошибок по типам
6. **Время выполнения** - среднее время выполнения операций коннектора

### Статистика пользователей

Статистика пользователей предоставляет информацию о пользователях и их активности:

1. **Активные пользователи** - количество активных пользователей по дням/неделям/месяцам
2. **Новые пользователи** - количество новых пользователей по дням/неделям/месяцам
3. **Конверсия из пробного периода** - процент пользователей, перешедших с пробного периода на платную подписку
4. **Отток пользователей** - процент пользователей, отменивших подписку
5. **Активность пользователей** - распределение пользователей по уровню активности

### Финансовая статистика

Финансовая статистика предоставляет информацию о доходах и платежах:

1. **Доход по дням/неделям/месяцам** - общий доход по периодам
2. **Доход по коннекторам** - распределение дохода по коннекторам
3. **Средний доход на пользователя (ARPU)** - средний доход на одного пользователя
4. **Пожизненная ценность клиента (LTV)** - оценка пожизненной ценности клиента
5. **Неудачные платежи** - статистика по неудачным платежам и их причинам

### Статистика ошибок

Статистика ошибок предоставляет информацию об ошибках и проблемах:

1. **Общее количество ошибок** - общее количество ошибок по дням/неделям/месяцам
2. **Распределение ошибок по коннекторам** - распределение ошибок по коннекторам
3. **Распределение ошибок по типам** - распределение ошибок по типам
4. **Наиболее частые ошибки** - список наиболее частых ошибок
5. **Тренды ошибок** - изменение количества ошибок во времени

### API для аналитики

Для доступа к аналитическим данным предоставляется API:

```
GET /api/v1/analytics/overview
GET /api/v1/analytics/connectors
GET /api/v1/analytics/connectors/{id}
GET /api/v1/analytics/users
GET /api/v1/analytics/financial
GET /api/v1/analytics/errors
```

Пример ответа API:

```json
{
  "active_users": 1234,
  "active_subscriptions": 2345,
  "operations_total": 123456,
  "error_rate": 0.023,
  "revenue": 12345.67,
  "connectors": [
    {
      "id": "crm-connector",
      "name": "CRM Connector",
      "active_subscriptions": 234,
      "operations_total": 23456,
      "error_rate": 0.012
    },
    {
      "id": "payment-connector",
      "name": "Payment Connector",
      "active_subscriptions": 123,
      "operations_total": 12345,
      "error_rate": 0.034
    }
  ]
}
```

### Экспорт данных

Администраторы могут экспортировать аналитические данные в различных форматах:

1. **CSV** - экспорт данных в формате CSV для дальнейшей обработки
2. **Excel** - экспорт данных в формате Excel для анализа
3. **PDF** - экспорт отчетов в формате PDF для презентаций

## Система оповещений о проблемах и сбоях

### Архитектура системы оповещений

Система оповещений о проблемах и сбоях построена на основе следующих компонентов:

1. **Мониторинг** - отслеживание метрик и событий
2. **Анализ** - анализ метрик и событий для выявления проблем
3. **Оповещение** - отправка уведомлений о проблемах
4. **Эскалация** - эскалация проблем при необходимости

### Типы оповещений

Система поддерживает следующие типы оповещений:

1. **Критические** - оповещения о критических проблемах, требующих немедленного вмешательства
2. **Предупреждения** - оповещения о потенциальных проблемах, требующих внимания
3. **Информационные** - оповещения о важных событиях, не требующих вмешательства

### Каналы оповещений

Оповещения могут отправляться по различным каналам:

1. **Email** - отправка оповещений по электронной почте
2. **Slack** - отправка оповещений в Slack
3. **SMS** - отправка оповещений по SMS
4. **Webhook** - отправка оповещений через webhook
5. **PagerDuty** - интеграция с PagerDuty для управления инцидентами

### Правила оповещений

Система оповещений использует следующие правила:

1. **Высокий процент ошибок** - оповещение при превышении порога ошибок
2. **Высокое время отклика** - оповещение при превышении порога времени отклика
3. **Недоступность сервиса** - оповещение при недоступности сервиса
4. **Аномальная активность** - оповещение при обнаружении аномальной активности
5. **Проблемы с платежами** - оповещение при проблемах с платежами

#### Пример правила оповещения в Prometheus Alertmanager

```yaml
groups:
- name: connector_alerts
  rules:
  - alert: HighErrorRate
    expr: sum(rate(connector_errors_total[5m])) / sum(rate(connector_operations_total[5m])) > 0.05
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is above 5% for the last 5 minutes"

  - alert: HighResponseTime
    expr: histogram_quantile(0.95, sum(rate(connector_operation_duration_seconds_bucket[5m])) by (le)) > 1.0
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High response time detected"
      description: "95th percentile of response time is above 1 second for the last 5 minutes"

  - alert: ConnectorDown
    expr: up{job="connector"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Connector is down"
      description: "Connector has been down for more than 1 minute"
```

### Процесс обработки инцидентов

При возникновении инцидента система выполняет следующие действия:

1. **Обнаружение** - система обнаруживает проблему на основе метрик и событий
2. **Классификация** - система классифицирует проблему по типу и серьезности
3. **Оповещение** - система отправляет оповещения ответственным лицам
4. **Эскалация** - если проблема не решается в течение определенного времени, система эскалирует проблему
5. **Разрешение** - после решения проблемы система отправляет оповещение о разрешении
6. **Анализ** - после разрешения проблемы проводится анализ причин и последствий

### Дежурства и эскалация

Для обеспечения оперативного реагирования на проблемы используется система дежурств и эскалации:

1. **Дежурные инженеры** - инженеры, ответственные за реагирование на проблемы в определенное время
2. **Уровни эскалации** - различные уровни эскалации проблем в зависимости от их серьезности и времени без решения
3. **Ротация дежурств** - регулярная ротация дежурных инженеров для распределения нагрузки

#### Пример конфигурации дежурств в PagerDuty

```json
{
  "schedules": [
    {
      "id": "PABCDEF",
      "name": "Primary On-Call",
      "time_zone": "Europe/Moscow",
      "escalation_policies": [
        {
          "id": "PQRSTUV",
          "name": "Primary Escalation Policy",
          "escalation_rules": [
            {
              "escalation_delay_in_minutes": 30,
              "targets": [
                {
                  "id": "PXYZ123",
                  "type": "user_reference",
                  "summary": "John Doe"
                }
              ]
            },
            {
              "escalation_delay_in_minutes": 30,
              "targets": [
                {
                  "id": "PABC456",
                  "type": "user_reference",
                  "summary": "Jane Smith"
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
```

### Мониторинг внешних зависимостей

Система также отслеживает состояние внешних зависимостей:

1. **API внешних сервисов** - мониторинг доступности и производительности API внешних сервисов
2. **Платежные системы** - мониторинг доступности и функциональности платежных систем
3. **Сервисы отправки уведомлений** - мониторинг доступности и функциональности сервисов отправки уведомлений

### Оповещения для пользователей

Помимо оповещений для администраторов, система также отправляет оповещения пользователям:

1. **Плановые технические работы** - оповещения о плановых технических работах
2. **Проблемы с коннекторами** - оповещения о проблемах с коннекторами, используемыми пользователем
3. **Проблемы с платежами** - оповещения о проблемах с платежами пользователя

## Интеграция с внешними системами мониторинга

Система мониторинга и аналитики интегрируется с внешними системами:

1. **Datadog** - интеграция с Datadog для расширенного мониторинга и аналитики
2. **New Relic** - интеграция с New Relic для мониторинга производительности
3. **Sentry** - интеграция с Sentry для отслеживания ошибок
4. **PagerDuty** - интеграция с PagerDuty для управления инцидентами

### Пример интеграции с Sentry

```javascript
// Инициализация Sentry
Sentry.init({
  dsn: 'https://examplePublicKey@o0.ingest.sentry.io/0',
  integrations: [
    new Sentry.Integrations.Http({ tracing: true }),
    new Sentry.Integrations.Express({ app }),
  ],
  tracesSampleRate: 1.0,
});

// Middleware для отслеживания ошибок
app.use(Sentry.Handlers.requestHandler());
app.use(Sentry.Handlers.tracingHandler());

// Обработка ошибок
app.use(Sentry.Handlers.errorHandler());
app.use((err, req, res, next) => {
  // Логирование ошибки
  console.error(err);

  // Отправка ответа
  res.status(500).json({
    error: 'Internal Server Error',
    requestId: req.headers['x-request-id']
  });
});
```

## Безопасность и доступ к данным

### Контроль доступа

Доступ к данным мониторинга и аналитики контролируется на основе ролей:

1. **Администраторы** - полный доступ ко всем данным
2. **Менеджеры** - доступ к агрегированным данным и отчетам
3. **Поддержка** - доступ к данным, необходимым для решения проблем пользователей
4. **Пользователи** - доступ только к своим данным

### Анонимизация данных

Для защиты конфиденциальности пользователей применяется анонимизация данных:

1. **Удаление персональных данных** - удаление персональных данных из логов и отчетов
2. **Агрегация данных** - использование агрегированных данных вместо индивидуальных
3. **Псевдонимизация** - замена идентификаторов пользователей на псевдонимы

### Аудит доступа

Все действия с данными мониторинга и аналитики логируются для аудита:

1. **Кто** - кто получил доступ к данным
2. **Что** - к каким данным был получен доступ
3. **Когда** - когда был получен доступ
4. **Откуда** - с какого IP-адреса был получен доступ
5. **Зачем** - причина доступа к данным

## Планы развития системы мониторинга и аналитики

### Краткосрочные планы

1. **Улучшение визуализации** - улучшение дашбордов и отчетов
2. **Расширение метрик** - добавление новых метрик для более детального мониторинга
3. **Интеграция с дополнительными системами** - интеграция с дополнительными системами мониторинга и аналитики

### Среднесрочные планы

1. **Предиктивная аналитика** - внедрение предиктивной аналитики для прогнозирования проблем
2. **Автоматическое реагирование** - автоматическое реагирование на определенные типы проблем
3. **Расширенная аналитика пользователей** - более детальная аналитика поведения пользователей

### Долгосрочные планы

1. **Машинное обучение** - использование машинного обучения для выявления аномалий и прогнозирования проблем
2. **Самовосстанавливающиеся системы** - внедрение самовосстанавливающихся систем для автоматического устранения проблем
3. **Расширенная бизнес-аналитика** - интеграция технических метрик с бизнес-метриками для комплексного анализа
